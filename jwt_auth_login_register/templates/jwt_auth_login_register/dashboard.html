{%  extends 'jwt_auth_login_register/main2.html' %}
{% load static %}
{% block content %}
<link rel="stylesheet" type="text/css" href="{%static 'css/main.css'%}">

{%  include 'jwt_auth_login_register/status.html' %}

<script>
	var access_token = window.localStorage.getItem("access_token");
	$.ajax({
		url:"/app/check_role/",
		type:"GET",
		headers: {
			"Authorization": access_token,
		},
		success:function(response){

		},
		error:function(xhr,a,b){
			window.location.pathname = '/app/home/';
		}
	});
</script>

<div class="row">
	<div class="col-md-5">
		<h5 id="totat_customer"></h5>
		<hr>
		<div class="card card-body">
			<!--<a class="btn btn-primary  btn-sm btn-block" href="">Create Customer</a>-->
			<table class="table table-sm" id = "table">
				<tr>
					<th></th>
					<th>Customer Name</th>
					<th>E-mail</th>
				</tr>
			</table>
		</div>
	</div>

	<div class="col-md-7">
		<h5>ORDERS</h5>
		<hr>
		<div class="card card-body">

			<table class="table table-sm" id="order_table">
				<tr>
					<th>Product</th>
					<th>Date Orderd</th>
					<th>Address</th>
					<th>Status</th>
					<th>Update</th>
					<th>Remove</th>
				</tr>

			</table>
		</div>
	</div>
</div>

<script>
	var access_token = window.localStorage.getItem("access_token");
	$.ajax({
		url:"/app/getallusers/",
		type:"GET",
		headers: {
			"Authorization": access_token,
		},
		success:function(response){
			users = response;
			$("#totat_customer").html("CUSTOMERS:"+users.length)
			for(user of users)
				$("#table").append("<tr>\
					 <td><a href='/app/customer/"+user.id+"/' class='btn btn-sm btn-info'>View</a></td>\
					 <td>"+user.first_name+" "+user.last_name+"</td>\
					 <td>"+user.email+"</td>\
					 <tr>");
		},
		error:function(xhr,a,b){
			if(xhr.status==401){
				window.location.pathname = '/app/login/';
			}
			else{
				console.log(xhr);
			}
		}
	});
	$.ajax({
		url:"/app/getallorders/",
		type:"GET",
		headers: {
			"Authorization": access_token,
		},
		success:function(response){
			var orders = response;
			if(orders.length){
				$("#total_order").html(orders[0]['total_order']);
				$("#order_delivered").html(orders[0]['delivered_order']);
				$("#pending_order").html(orders[0]['pending_order']);
			}
			else{
				$("#total_order").html(0);
				$("#order_delivered").html(0);
				$("#pending_order").html(0);
			}
			function get_uuid(s){
				uuid = s.split("/")[5];
                return uuid;
            }
			for(order of orders)
				$("#order_table").append("<tr> \
					<td>"+order['purchase']['box']+"</td>\
					<td>"+order['date']+"</td>\
					<td>"+order['address']+", "+order['city']+", "+order['state']+"- "+order['zip_code']+"</td>\
					<td>"+order['status']+"</td>\
					<td><a class='btn btn-sm btn-info' href='/app/updateorder/"+order['id']+"/'>Update</a></td>\
					<td class='order' ><a class='btn btn-sm btn-danger' href='#'>Delete</a></td>\
					</tr>");

			var closebtns = document.getElementsByClassName("order");
            for (var i = 0; i < closebtns.length; i++) {
                closebtns[i].addEventListener("click", function() {
                 	this.parentElement.style.display = 'none';
                 	uuid = get_uuid(this.parentElement.children[3].children[0].href);
                 	$.ajax({ 
						url: "/app/deleteorder/",
                        type: "DELETE",
                        headers: {
                            "Authorization": access_token,
                        },
                        data:{
							"csrfmiddlewaretoken" : "{{ csrf_token }}",
                            "uuid":uuid,
                        },
                        success: function(response) {
							var total_order = parseInt($("#total_order").html());
							total_order = total_order - 1;
							$("#total_order").html(total_order);
                        },
                        error: function(xhr, a, b){
							if(xhr.status==401){
								window.location.pathname = '/app/login/';
							}
							else{
								console.log(xhr);
							}
                        }
                    });
                });           
            }
		},
		error:function(xhr,a,b){
			console.log(xhr);
		}
	});

</script>

{% endblock %}